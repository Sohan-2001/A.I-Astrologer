/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All data is private to a specific user (profiles, predictions, messages). Access is granted based on the authenticated user's ID matching the path.
 * Data Structure: All user-specific data is organized hierarchically under the /users/{userId} path, enabling simple and secure path-based authorization.
 * Key Security Decisions:
 * - User Enumeration is Disallowed: The top-level /users collection cannot be listed, protecting user privacy.
 * - Strict Ownership: A user can only access and manage their own /users/{userId} document and any subcollections within it, such as /predictions, /birthDetails, and /messages.
 * - Immutability: User-created documents like birth details and messages generally cannot be updated by the user after creation to preserve history, though deletion might be allowed.
 * Denormalization for Authorization: The strict path-based ownership model minimizes the need for denormalization for authorization purposes.
 * Structural Segregation: Private user data (profiles, predictions, birthDetails, messages) is structurally separated into user-specific subcollections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * A robust check for update/delete operations, ensuring the document
     * exists and the user is the owner. Prevents operations on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Manages feedback submissions. Any authenticated user can submit feedback. Reading, updating, and deleting feedback is disallowed to maintain privacy and data integrity.
     * @path /feedbacks/{feedbackId}
     * @allow (create) Any authenticated user can create a feedback document.
     * @deny (read, update, delete) All other operations are disallowed.
     * @principle Collects user feedback securely without exposing other users' submissions.
     */
    match /feedbacks/{feedbackId} {
      allow read, update, delete: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    /**
     * @description Manages user profile documents. Only the user themselves can read, create, update, or delete their own profile. Listing all users is forbidden.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document: `auth.uid == 'user123'` on `/users/user123`.
     * @deny (get) An authenticated user trying to read another user's profile: `auth.uid == 'user456'` on `/users/user123`.
     * @principle Restricts access to a user's own data tree, preventing unauthorized data access and user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages a user's private astrological predictions. Access is strictly limited to the owner of the parent user document.
       * @path /users/{userId}/predictions/{predictionId}
       * @allow (create) A user creating a prediction for themselves: `auth.uid == 'user123'` on `/users/user123/predictions/pred456`.
       * @deny (list) An authenticated user trying to list another user's predictions: `auth.uid == 'user456'` on `/users/user123/predictions`.
       * @principle Enforces strict data ownership within a user-specific subcollection using path-based security.
       */
      match /predictions/{predictionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
      }
      
      /**
       * @description Manages a user's private birth details. Access is strictly limited to the owner of the parent user document.
       * @path /users/{userId}/birthDetails/{birthDetailId}
       * @allow (create) A user creating their birth details: `auth.uid == 'user123'` on `/users/user123/birthDetails/detail456`.
       * @deny (list) An authenticated user trying to list another user's birth details: `auth.uid == 'user456'` on `/users/user123/birthDetails`.
       * @principle Enforces strict data ownership within a user-specific subcollection using path-based security.
       */
      match /birthDetails/{birthDetailId} {
        allow get, list, create, update, delete: if isOwner(userId);
      }
      
      /**
       * @description Manages a user's private chat messages. Access is strictly limited to the owner of the parent user document.
       * @path /users/{userId}/messages/{messageId}
       * @allow (list) A user listing their own messages: `auth.uid == 'user123'` on `/users/user123/messages`.
       * @deny (get) An authenticated user trying to read another user's messages: `auth.uid == 'user456'` on `/users/user123/messages/msg789`.
       * @principle Enforces strict data ownership for conversations within a user-specific subcollection.
       */
      match /messages/{messageId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
    